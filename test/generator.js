const fs = require('fs');
const path = require('path');
const yaml = require('js-yaml');
const ssri = require('ssri');

const vendorsFile = fs.readFileSync(
  path.join(path.dirname(require.resolve('hexo-theme-next')), '_vendors.yml')
);
const dependencies = yaml.load(vendorsFile);
const newPlugins = require('../package.json').dependencies;

async function main() {
  for (const [key, value] of Object.entries(dependencies)) {
    const { name, file } = value;
    const dep = dependencies[key];
    dep.version = newPlugins[name];
    if (process.argv[2] === '--without-integrity' || !file) continue;
    // Generate Subresource Integrity (SRI) via ssri
    const integrity = await ssri
      .fromStream(fs.createReadStream(`./node_modules/${name}/${file}`), { algorithms: ['sha256'] })
    dep.integrity = integrity.toString();
  }
  const dump = `# This file is automatically generated
# See https://github.com/next-theme/plugins

${yaml.dump(dependencies)}`;
  try {
    fs.writeFileSync('_vendors.yml', dump);
  } catch (error) {
    console.error(error);
  }
}

main();
